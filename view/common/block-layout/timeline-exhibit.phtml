<?php
/**
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\SitePageBlockRepresentation $block
 * @var string $options
 */

$plugins = $this->getHelperPluginManager();
$url = $plugins->get('url');
$setting = $plugins->get('setting');
$escapeAttr = $plugins->get('escapeHtmlAttr');
$siteSetting = $plugins->get('siteSetting');

$blockId = $block->id();
$jsonTimelineUrl = json_encode($url('api/timeline', ['block-id' => $blockId]), 320);

// @see https://timeline.knightlab.com/docs/options.html
$options = json_decode($options, true) ?: [];
$options += [
    'start_at_slide' => 0,
    'language' => substr($siteSetting('locale', ''), 0, 2) ?: (substr($setting('locale', ''), 0, 2) ?: 'en'),
];

// The container size is required inline to avoid 0-height issues with some themes.
if (isset($options['container_style'])) {
    $containerStyle = $options['container_style'];
    unset($options['container_style']);
} else {
    $containerStyle = 'width: 100%; height: 80vh;';
}

$options = json_encode($options, 320);

$js = <<<JS
jQuery(document).ready(function($) {
    var timelineId = 'timeline-$blockId';
    var timelineUrl = $jsonTimelineUrl;
    var timelineOptions = $options;
    $.getJSON(timelineUrl, function(data) {
        window.timeline = new TL.Timeline(timelineId, data, timelineOptions);
    });
});
JS;
$this->headScript()->appendScript($js);
?>

<div id="timeline-<?= $blockId ?>" class="timeline" style="<?= $escapeAttr($containerStyle) ?>"></div>
